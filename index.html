<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>生成像素图片</title>
  <style>
    html,
    body {
      margin: 0;
      padding: 0;
    }

    .body {
      display: flex;
      flex-wrap: nowrap;
    }

    .body>section:first-child {
      margin-right: 12px;
    }
  </style>
</head>

<body>
  <div class="main">
    <div class="head">
      <input type="file" accept="image/*" oninput="selectImage(event)">
      <input class="resolutionIpt" type="number" placeholder="像素大小" oninput="changeResolution(event.target.value)">
      <button onclick="getPixivImage()">生成像素风</button>
      <button onclick="donwload()">下载图片</button>
    </div>

    <div class="body">
      <section>
        <h3 class="title">Image</h3>
        <img src="" alt="" srcset="">
      </section>
      <section>
        <h3>Canvas</h3>
        <canvas id="myCv"></canvas>
      </section>
    </div>
  </div>

  <script>
    let url = ''
    let resolution = 3 // 3*3

    // 像素化后的所有颜色
    const allColor = new Set()
    document.querySelector('.resolutionIpt').value = resolution

    const changeResolution = (val) => {
      resolution = +val
    }

    const selectImage = (e) => {
      const imageData = e.target.files[0]
      url = window.URL.createObjectURL(imageData)
      document.querySelector('img').src = url
    }

    const getPixivImage = () => {
      let imageUrl = ''
      let myCanvas = document.getElementById('myCv')
      var ctx = myCanvas.getContext('2d')
      var myImage = new Image()
      myImage.src = url
      myImage.setAttribute('crossOrigin', 'anonymous')
      myImage.onload = function () {
        myCanvas.width = myImage.width
        myCanvas.height = myImage.height
        // 显示原图分辨率
        document.querySelector('.title').innerText = document.querySelector('.title').innerText.replace(/([a-zA-Z]+).*/g, '$1') + ` ${myImage.width}*${myImage.height}`

        ctx.drawImage(myImage, 0, 0, myImage.width, myImage.height)

        cvData = ctx.getImageData(0, 0, myImage.width, myImage.height)
        const allDots = []
        for (let index = 0; index < cvData.data.length; index = index + 4) {
          const dot = [cvData.data[index], cvData.data[index + 1], cvData.data[index + 2], cvData.data[index + 3]]
          allDots.push(dot)
        }

        const allW = myImage.width
        const allH = myImage.height
        for (let w = 0; w < allW; w += resolution) {
          for (let h = 0; h < allH; h += resolution) {
            const index = w + allW * h
            const arr = []
            for (let i = 0; i < resolution; i++) {
              for (let j = 0; j < resolution; j++) {
                arr.push(allDots[(w + j) + (h + i) * allW])
              }
            }
            const newDot = handler(arr)
          }
        }

        const newData = allDots.flat()
        for (let index = 0; index < cvData.data.length; index++) {
          cvData.data[index] = newData[index]
        }
        ctx.putImageData(cvData, 0, 0)
        marchColor()
      }
    }

    // data.length === resolution * resolution eg: 3*3 [[],[],[],[],[],[],[],[],[]]
    // 将所有像素的颜色取均值
    var handler = (data = []) => {
      try {
        const realNum = data.filter(Boolean).length
        let r = 0, g = 0, b = 0, a = 0
        for (const dot of data) {
          if (dot === undefined || dot[0] === undefined) break
          r += dot[0]
          g += dot[1]
          b += dot[2]
          a += dot[3]
        }
        r /= realNum
        g /= realNum
        b /= realNum
        a /= realNum
        allColor.add([Math.round(r), Math.round(g), Math.round(b), Math.round(a)].toString())
        for (const dot of data) {
          if (dot === undefined || dot[0] === undefined) break
          dot[0] = Math.round(r)
          dot[1] = Math.round(g)
          dot[2] = Math.round(b)
          dot[3] = Math.round(a)
        }
      } catch {
        console.warn(data)
      }
    }

    var marchColor = () => {
      // TODO
    }

    var donwload = () => {
      let myCanvas = document.getElementById('myCv')
      myCanvas.toBlob((blob) => {
        const uri = window.URL.createObjectURL(blob)
        const a = document.createElement('a')
        a.style.display = 'none';
        a.href = uri;
        a.download = '像素图'
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(uri)
      })
    }

    // 仅log一次
    var logfunc = (data) => {
      console.info(data)
      logfunc = undefined
    }
  </script>
</body>

</html>